<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <meta charset="UTF-8">
  <title>SmartBot Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    :root {
      --primary: #0d6efd;
      --dark-bg: #121212;
      --light-bg: #f8f9fa;
      --dark-card: #1f1f1f;
      --light-card: #ffffff;
      --text-dark: #e0e0e0;
      --text-light: #212529;
      --accent: #ffc107;
    }

    [data-theme="dark"] {
      --bg-color: var(--dark-bg);
      --text-color: var(--text-dark);
      --card-bg: var(--dark-card);
    }

    [data-theme="light"] {
      --bg-color: var(--light-bg);
      --text-color: var(--text-light);
      --card-bg: var(--light-card);
    }

    body {
      background-color: var(--bg-color);
      color: var(--text-color);
      transition: 0.3s ease all;
      padding: 1rem;
    }

    .card {
      background-color: var(--card-bg) !important;
      transition: background 0.3s;
    }

    .table th {
      background-color: var(--primary);
      color: white;
    }

    .btn-toggle {
      background-color: var(--accent);
      color: black;
    }

    .btn-toggle:hover {
      background-color: #e0a800;
    }

    #popup {
      display: none;
      position: fixed;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1000;
      padding: 0.75rem 1.5rem;
      border-radius: 6px;
      background: var(--card-bg);
      border: 1px solid #aaa;
      color: var(--text-color);
    }
  </style>
</head>
<body>
  <div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h2>ğŸ“ˆ Smart Trading Dashboard</h2>
      <div>
        <button class="btn btn-outline-primary me-2" onclick="toggleTheme()">ğŸŒ“ Theme</button>
        <button class="btn btn-danger" onclick="logout()">Logout</button>
      </div>
    </div>

    <div class="card p-3 mb-4">
      <h4>ğŸ‘¤ Welcome, <span id="greetingUser">User</span></h4>
    </div>

    <div class="row g-3">
      <!-- Strategy Selection -->
      <div class="col-lg-6">
        <div class="card p-3">
          <h5>ğŸ“Š Select Strategy</h5>
          <select id="strategy" class="form-select" onchange="updateStrategy()">
            <option value="balanced">Balanced</option>
            <option value="momentum">Momentum</option>
            <option value="reversal">Reversal</option>
            <option value="volume_spike">Volume Spike</option>
          </select>
        </div>
      </div>

      <!-- Bot Selector -->
      <div class="col-lg-6">
        <div class="card p-3 d-flex align-items-center justify-content-center">
          <div>
            <h5>ğŸ¤– Choose a Trading Bot</h5>
            <button class="btn btn-outline-dark mt-2" onclick="location.href='bot-selection.html'">Go to Bot Selection</button>
          </div>
        </div>
      </div>

      <!-- Portfolio -->
      <div class="col-lg-6">
        <div class="card p-3">
          <h5>ğŸ’¼ Portfolio</h5>
          <ul class="list-unstyled mb-0">
            <li>ğŸ’° Cash: <span id="cash">--</span></li>
            <li>ğŸ“ˆ Market Value: <span id="market_value">--</span></li>
            <li>ğŸ’µ Total Equity: <span id="equity">--</span></li>
            <li>ğŸ“Š Unrealized P/L: <span id="pnl">--</span></li>
          </ul>
        </div>
      </div>

      <!-- Alpaca Connect -->
      <div class="col-lg-6">
        <div class="card p-3">
          <h5>ğŸ” Connect Alpaca API</h5>
          <input type="text" id="alpacaKey" class="form-control mb-2" placeholder="API Key">
          <input type="text" id="alpacaSecret" class="form-control mb-2" placeholder="Secret Key">
          <button class="btn btn-success" onclick="connectAlpaca()">Connect</button>
        </div>
      </div>

      <!-- Suggestions -->
      <div class="col-lg-12">
        <div class="card p-3">
          <h5>ğŸ”¥ Suggested Trades</h5>
          <table class="table table-bordered table-hover mt-2 text-center">
            <thead>
              <tr>
                <th>Symbol</th>
                <th>Price</th>
                <th>Change%</th>
                <th>Action</th>
                <th>Trade</th>
              </tr>
            </thead>
            <tbody id="suggested-body">
              <tr><td colspan="5">Loading...</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Logs -->
      <div class="col-lg-12">
        <div class="card p-3">
          <h5>ğŸ“‹ Trade Logs</h5>
          <table class="table table-striped text-center">
            <thead>
              <tr>
                <th>Time</th>
                <th>Symbol</th>
                <th>Action</th>
                <th>Qty</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody id="log-body">
              <tr><td colspan="5">Loading...</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Chart -->
      <div class="col-lg-12">
        <div class="card p-3">
          <h5>ğŸ“ˆ TradingView Chart</h5>
          <iframe id="chart-frame" height="400" src="https://s.tradingview.com/embed-widget/symbol-overview/?symbol=NASDAQ:AAPL&interval=D&theme=light" loading="lazy"></iframe>
        </div>
      </div>
    </div>
  </div>

  <div id="popup"><span id="popup-message"></span></div>

  <script>
    let user = "";

    document.addEventListener("DOMContentLoaded", () => {
      user = localStorage.getItem("userId");
      if (!user) return location.href = "login.html";
      document.getElementById("greetingUser").textContent = user;
      loadUserData();
    });

    function toggleTheme() {
      const root = document.documentElement;
      const theme = root.getAttribute("data-theme") === "dark" ? "light" : "dark";
      root.setAttribute("data-theme", theme);
      updateChart("AAPL");
    }

    function logout() {
      localStorage.removeItem("userId");
      location.href = "login.html";
    }

    function loadUserData() {
      fetch(`https://multi-user-trading-bot.onrender.com/portfolio/${user}`)
        .then(res => res.json())
        .then(data => {
          if (data.status === "success") {
            document.getElementById("cash").innerText = `$${data.cash}`;
            document.getElementById("market_value").innerText = `$${data.market_value}`;
            document.getElementById("equity").innerText = `$${data.equity}`;
            document.getElementById("pnl").innerText = `$${data.pnl}`;
          }
        });

      fetch(`https://multi-user-trading-bot.onrender.com/logs/${user}`)
        .then(res => res.json())
        .then(logs => {
          const tbody = document.getElementById("log-body");
          tbody.innerHTML = logs.length ? "" : `<tr><td colspan="5">No logs.</td></tr>`;
          logs.forEach(log => {
            tbody.innerHTML += `<tr>
              <td>${log.timestamp}</td>
              <td>${log.symbol}</td>
              <td>${log.action}</td>
              <td>${log.quantity}</td>
              <td>${log.status}</td>
            </tr>`;
          });
        });

      fetch(`https://multi-user-trading-bot.onrender.com/suggested/${user}`)
        .then(res => res.json())
        .then(suggestions => {
          const tbody = document.getElementById("suggested-body");
          tbody.innerHTML = "";
          suggestions.forEach(item => {
            tbody.innerHTML += `<tr>
              <td>${item.symbol}</td>
              <td>$${item.current_price}</td>
              <td>${item.change_percent}%</td>
              <td>${item.suggestion}</td>
              <td><button class="btn btn-sm btn-outline-success" onclick="autoTrade('${item.symbol}', '${item.suggestion.toLowerCase()}')">Trade</button></td>
            </tr>`;
          });
          if (suggestions.length > 0) updateChart(suggestions[0].symbol);
        });

      fetch(`https://multi-user-trading-bot.onrender.com/strategy/${user}`)
        .then(res => res.json())
        .then(data => {
          if (data.strategy) document.getElementById("strategy").value = data.strategy;
        });
    }

    function updateStrategy() {
      const strategy = document.getElementById("strategy").value;
      fetch(`https://multi-user-trading-bot.onrender.com/strategy/${user}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ strategy })
      });
    }

    function updateChart(symbol) {
      const theme = document.documentElement.getAttribute("data-theme") === "dark" ? "dark" : "light";
      const frame = document.getElementById("chart-frame");
      frame.src = `https://s.tradingview.com/embed-widget/symbol-overview/?symbol=NASDAQ:${symbol}&interval=D&theme=${theme}`;
    }

    function autoTrade(symbol, action) {
      fetch(`https://multi-user-trading-bot.onrender.com/webhook/${user}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ symbol, action, quantity: 1 })
      })
      .then(res => res.json())
      .then(data => {
        showPopup(data.message || (data.status === "success" ? "âœ… Trade Placed!" : "âŒ Trade Failed"), data.status === "success");
        loadUserData();
      });
    }

    function connectAlpaca() {
      const apiKey = document.getElementById("alpacaKey").value.trim();
      const secretKey = document.getElementById("alpacaSecret").value.trim();
      if (!apiKey || !secretKey) return showPopup("âŒ API Key and Secret Key required", false);

      fetch("https://multi-user-trading-bot.onrender.com/connect-alpaca", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ user_id: user, api_key: apiKey, secret_key: secretKey })
      })
      .then(res => res.json())
      .then(data => {
        showPopup(data.message || (data.status === "success" ? "âœ… Connected" : "âŒ Failed"), data.status === "success");
      });
    }

    function showPopup(message, success = true) {
      const popup = document.getElementById("popup");
      popup.innerText = message;
      popup.style.borderColor = success ? "green" : "red";
      popup.style.color = success ? "green" : "red";
      popup.style.display = "block";
      setTimeout(() => popup.style.display = "none", 4000);
    }
  </script>
</body>
</html>
